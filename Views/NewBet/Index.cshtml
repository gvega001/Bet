@model Bet.DTO.NewBetDto

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>New Bet</h2>

<form id="newBet">
    <div class="form-group">
        <label>Game</label>
        <div class="tt-container">
            <input id="games" name="game" data-rule-ValidGame="true" required type="text" value="" class="form-control"/>
        </div>
    </div>
    <div class="form-group">
        <label>Group</label>
        <div class="tt-container">
            <input id="groups" name="group" data-rule-ValidGroup="true" required type="text" value="" class="form-control" />
        </div>
    </div>
    <div class="form-group">
        <label>Bet Amount</label>
        <input type="text" name="betAmount" required value="" class="form-control" />
    </div>
    <div class="form-group">
        <label>Select Team</label>
        <input type="text" name="team" required value="" class="form-control" />
    </div>
    <div class="form-group">
        <label>Guess</label>
        <input type="text" name="quess" required value="" class="form-control" />
    </div>
    <button class="btn btn-primary">Make Bet</button>
</form>

@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {
            var vm = {};

            var games = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                prefetch: '../data/films/post_1960.json',
                remote: {
                    url: 'api/games?query=%QUERY',
                    wildcard: '%QUERY'
                }
            });

            $('#games').typeahead({
                minLength: 3,
                highlight: true
            }, {
                name: 'games',
                display: 'name',
                source: games
            }).on("typeahead:select", function(e, games) {
                vm.gameId = games.id;
            });

            var groups = new Bloodhound({
                datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                prefetch: '../data/films/post_1960.json',
                remote: {
                    url: 'api/groups?query=%QUERY',
                    wildcard: '%QUERY'
                }
            });

            $('#groups').typeahead({
                minLength: 3,
                highlight: true
            }, {
                name: 'groups',
                display: 'names',
                source: groups
            }).on("typeahead:select", function(f, groups) {
                vm.groupId = groups.id;
            });

            $.validator.addMethod("validBet", function() {
                return vm.gameId && vm.groupId !== 0;
            },"Please select a valid game and group");

           var validator= $("#newBet").validate({
                submitHandler: function() {
                    $.ajax({
                            url: "/api/newBets",
                            method: "post",
                            data: vm
                        })
                        .done(function() {
                            toastr.success("Bet!");

                            $("#games").typeahead("val", "");
                            $("#groups").typeahead("val", "");
                            vm = { gameId: [], groupId: [] }
                            validator.resetForm();
                        })
                        .fail(function() {
                            toastr.fail("Something unexpected happened.");
                        });
                    return false;
                }
            });

        });
    </script>
}
